<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯é›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª å‰åç«¯é›†æˆæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. åŸºç¡€è¿æ¥æµ‹è¯•</h2>
            <button onclick="testConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
            <div id="connection-result"></div>
        </div>

        <div class="test-section">
            <h2>2. è¡¨å•åˆ†ç±»æµ‹è¯•</h2>
            <button onclick="testFormCategories()">è·å–è¡¨å•åˆ†ç±»</button>
            <div id="categories-result"></div>
        </div>

        <div class="test-section">
            <h2>3. è¡¨å•CRUDæµ‹è¯•</h2>
            <button onclick="testFormCRUD()">å®Œæ•´è¡¨å•æµ‹è¯•</button>
            <div id="crud-result"></div>
        </div>

        <div class="test-section">
            <h2>4. è¡¨å•è®¾è®¡å™¨æ•°æ®æµ‹è¯•</h2>
            <button onclick="testFormDesignerData()">æµ‹è¯•å¤æ‚è¡¨å•æ•°æ®</button>
            <div id="designer-result"></div>
        </div>

        <div class="test-section">
            <h2>5. æµ‹è¯•ç»“æœæ±‡æ€»</h2>
            <div id="summary-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api'; // ä½¿ç”¨ä»£ç†
        let testResults = [];

        function addResult(section, type, message, data = null) {
            const resultDiv = document.getElementById(section + '-result');
            const resultElement = document.createElement('div');
            resultElement.className = `test-result ${type}`;
            resultElement.innerHTML = message;
            
            if (data) {
                const jsonDiv = document.createElement('div');
                jsonDiv.className = 'json-display';
                jsonDiv.textContent = JSON.stringify(data, null, 2);
                resultElement.appendChild(jsonDiv);
            }
            
            resultDiv.appendChild(resultElement);
            testResults.push({section, type, message, timestamp: new Date()});
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary-result');
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const totalCount = testResults.length;
            
            summaryDiv.innerHTML = `
                <div class="test-result info">
                    <strong>æµ‹è¯•ç»Ÿè®¡ï¼š</strong><br>
                    æ€»è®¡: ${totalCount} | æˆåŠŸ: ${successCount} | å¤±è´¥: ${errorCount}<br>
                    æˆåŠŸç‡: ${totalCount > 0 ? Math.round((successCount / totalCount) * 100) : 0}%
                </div>
            `;
        }

        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '';
            
            try {
                addResult('connection', 'info', 'ğŸ”„ æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...');
                
                const response = await fetch(`${API_BASE}/form-categories`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('connection', 'success', 'âœ… åç«¯è¿æ¥æˆåŠŸï¼', {
                        status: response.status,
                        url: response.url,
                        responseType: data.success ? 'success' : 'unknown'
                    });
                } else {
                    addResult('connection', 'error', `âŒ è¿æ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
                }
            } catch (error) {
                addResult('connection', 'error', `âŒ è¿æ¥é”™è¯¯: ${error.message}`);
            }
        }

        async function testFormCategories() {
            const resultDiv = document.getElementById('categories-result');
            resultDiv.innerHTML = '';
            
            try {
                addResult('categories', 'info', 'ğŸ”„ æ­£åœ¨è·å–è¡¨å•åˆ†ç±»...');
                
                const response = await fetch(`${API_BASE}/form-categories`);
                const data = await response.json();
                
                if (data.success) {
                    const categories = data.data.categories || [];
                    addResult('categories', 'success', 
                        `âœ… è¡¨å•åˆ†ç±»è·å–æˆåŠŸï¼Œå…± ${categories.length} ä¸ªåˆ†ç±»`, 
                        categories.slice(0, 3) // åªæ˜¾ç¤ºå‰3ä¸ª
                    );
                } else {
                    addResult('categories', 'error', 'âŒ è·å–è¡¨å•åˆ†ç±»å¤±è´¥', data);
                }
            } catch (error) {
                addResult('categories', 'error', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function testFormCRUD() {
            const resultDiv = document.getElementById('crud-result');
            resultDiv.innerHTML = '';
            
            try {
                // 1. è·å–åˆ†ç±»
                addResult('crud', 'info', 'ğŸ”„ æ­¥éª¤1: è·å–è¡¨å•åˆ†ç±»...');
                const categoriesResponse = await fetch(`${API_BASE}/form-categories`);
                const categoriesData = await categoriesResponse.json();
                
                if (!categoriesData.success || !categoriesData.data.categories.length) {
                    addResult('crud', 'error', 'âŒ æ²¡æœ‰å¯ç”¨çš„è¡¨å•åˆ†ç±»');
                    return;
                }
                
                const categoryId = categoriesData.data.categories[0]._id;
                addResult('crud', 'success', 'âœ… è·å–åˆ°åˆ†ç±»ID: ' + categoryId);

                // 2. åˆ›å»ºè¡¨å•
                addResult('crud', 'info', 'ğŸ”„ æ­¥éª¤2: åˆ›å»ºæµ‹è¯•è¡¨å•...');
                const createData = {
                    name: 'å‰ç«¯æµ‹è¯•è¡¨å• ' + new Date().getTime(),
                    description: 'é€šè¿‡å‰ç«¯é›†æˆæµ‹è¯•åˆ›å»ºçš„è¡¨å•',
                    categoryId: categoryId,
                    content: {
                        metadata: {
                            version: '1.0.0',
                            createdAt: new Date().toISOString(),
                            designerVersion: '1.0.0'
                        },
                        config: {
                            components: [
                                {
                                    id: 'test_input_' + Date.now(),
                                    type: 'input',
                                    label: 'æµ‹è¯•è¾“å…¥æ¡†',
                                    placeholder: 'è¯·è¾“å…¥å†…å®¹',
                                    required: true,
                                    order: 0
                                }
                            ],
                            layout: { columns: 1, gutter: 16, responsive: true },
                            theme: { primaryColor: '#1890ff', fontSize: '14px' }
                        },
                        runtime: {
                            componentValues: {},
                            selectedServices: {},
                            orderItems: {}
                        }
                    },
                    status: 'draft'
                };

                const createResponse = await fetch(`${API_BASE}/forms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(createData)
                });
                
                const createResult = await createResponse.json();
                if (!createResult.success) {
                    addResult('crud', 'error', 'âŒ åˆ›å»ºè¡¨å•å¤±è´¥', createResult);
                    return;
                }
                
                const formId = createResult.data._id;
                addResult('crud', 'success', 'âœ… è¡¨å•åˆ›å»ºæˆåŠŸ, ID: ' + formId);

                // 3. è¯»å–è¡¨å•
                addResult('crud', 'info', 'ğŸ”„ æ­¥éª¤3: è¯»å–è¡¨å•...');
                const getResponse = await fetch(`${API_BASE}/forms/${formId}`);
                const getResult = await getResponse.json();
                
                if (getResult.success) {
                    addResult('crud', 'success', 'âœ… è¡¨å•è¯»å–æˆåŠŸ', {
                        name: getResult.data.name,
                        componentCount: getResult.data.content?.config?.components?.length || 0,
                        hasMetadata: !!getResult.data.content?.metadata,
                        hasTheme: !!getResult.data.content?.config?.theme
                    });
                } else {
                    addResult('crud', 'error', 'âŒ è¯»å–è¡¨å•å¤±è´¥', getResult);
                    return;
                }

                // 4. æ›´æ–°è¡¨å•
                addResult('crud', 'info', 'ğŸ”„ æ­¥éª¤4: æ›´æ–°è¡¨å•...');
                const updateData = {
                    description: 'å·²æ›´æ–°çš„æµ‹è¯•è¡¨å•',
                    content: {
                        ...getResult.data.content,
                        config: {
                            ...getResult.data.content.config,
                            components: [
                                ...getResult.data.content.config.components,
                                {
                                    id: 'test_select_' + Date.now(),
                                    type: 'select',
                                    label: 'æµ‹è¯•é€‰æ‹©æ¡†',
                                    options: [
                                        { label: 'é€‰é¡¹1', value: 'opt1' },
                                        { label: 'é€‰é¡¹2', value: 'opt2' }
                                    ],
                                    order: 1
                                }
                            ]
                        },
                        metadata: {
                            ...getResult.data.content.metadata,
                            updatedAt: new Date().toISOString()
                        }
                    }
                };

                const updateResponse = await fetch(`${API_BASE}/forms/${formId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const updateResult = await updateResponse.json();
                if (updateResult.success) {
                    addResult('crud', 'success', 'âœ… è¡¨å•æ›´æ–°æˆåŠŸï¼Œç»„ä»¶æ•°é‡: ' + 
                        (updateResult.data.content?.config?.components?.length || 0));
                } else {
                    addResult('crud', 'error', 'âŒ æ›´æ–°è¡¨å•å¤±è´¥', updateResult);
                    return;
                }

                // 5. åˆ é™¤è¡¨å•
                addResult('crud', 'info', 'ğŸ”„ æ­¥éª¤5: åˆ é™¤æµ‹è¯•è¡¨å•...');
                const deleteResponse = await fetch(`${API_BASE}/forms/${formId}`, {
                    method: 'DELETE'
                });
                
                const deleteResult = await deleteResponse.json();
                if (deleteResult.success) {
                    addResult('crud', 'success', 'âœ… è¡¨å•åˆ é™¤æˆåŠŸ');
                } else {
                    addResult('crud', 'error', 'âŒ åˆ é™¤è¡¨å•å¤±è´¥', deleteResult);
                }

            } catch (error) {
                addResult('crud', 'error', `âŒ CRUDæµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testFormDesignerData() {
            const resultDiv = document.getElementById('designer-result');
            resultDiv.innerHTML = '';
            
            try {
                // è·å–åˆ†ç±»
                const categoriesResponse = await fetch(`${API_BASE}/form-categories`);
                const categoriesData = await categoriesResponse.json();
                
                if (!categoriesData.success || !categoriesData.data.categories.length) {
                    addResult('designer', 'error', 'âŒ æ²¡æœ‰å¯ç”¨çš„è¡¨å•åˆ†ç±»');
                    return;
                }
                
                const categoryId = categoriesData.data.categories[0]._id;
                
                // åˆ›å»ºå¤æ‚è¡¨å•æ•°æ®
                addResult('designer', 'info', 'ğŸ”„ æ­£åœ¨æµ‹è¯•å¤æ‚è¡¨å•è®¾è®¡å™¨æ•°æ®...');
                
                const complexFormData = {
                    name: 'å¤æ‚è¡¨å•æµ‹è¯• ' + new Date().getTime(),
                    description: 'åŒ…å«å¤šç§ç»„ä»¶å’Œé€»è¾‘è§„åˆ™çš„å¤æ‚è¡¨å•',
                    categoryId: categoryId,
                    content: {
                        metadata: {
                            version: '1.0.0',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            designerVersion: '1.0.0'
                        },
                        config: {
                            components: [
                                {
                                    id: 'comp_input_001',
                                    type: 'input',
                                    label: 'ç”¨æˆ·å§“å',
                                    placeholder: 'è¯·è¾“å…¥æ‚¨çš„å§“å',
                                    required: true,
                                    order: 0,
                                    validation: [
                                        { type: 'required', message: 'å§“åä¸èƒ½ä¸ºç©º' }
                                    ]
                                },
                                {
                                    id: 'comp_select_001',
                                    type: 'select',
                                    label: 'ç”¨æˆ·ç±»å‹',
                                    options: [
                                        { label: 'æ™®é€šç”¨æˆ·', value: 'normal' },
                                        { label: 'é«˜çº§ç”¨æˆ·', value: 'premium' },
                                        { label: 'ä¼ä¸šç”¨æˆ·', value: 'enterprise' }
                                    ],
                                    required: true,
                                    order: 1
                                },
                                {
                                    id: 'comp_textarea_001',
                                    type: 'textarea',
                                    label: 'è¯¦ç»†éœ€æ±‚',
                                    placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚',
                                    required: false,
                                    order: 2,
                                    visibility: 'visible'
                                },
                                {
                                    id: 'comp_group_001',
                                    type: 'group',
                                    label: 'é«˜çº§é€‰é¡¹',
                                    order: 3,
                                    titleDisplay: 'show',
                                    titleAlign: 'left',
                                    parentId: undefined
                                },
                                {
                                    id: 'comp_radio_001',
                                    type: 'radio',
                                    label: 'æœåŠ¡ç­‰çº§',
                                    options: [
                                        { label: 'åŸºç¡€æœåŠ¡', value: 'basic' },
                                        { label: 'é«˜çº§æœåŠ¡', value: 'advanced' }
                                    ],
                                    parentId: 'comp_group_001',
                                    order: 0
                                }
                            ],
                            layout: {
                                columns: 1,
                                gutter: 16,
                                responsive: true,
                                padding: '24px',
                                componentSpacing: '16px',
                                labelPosition: 'top',
                                logicRules: [
                                    {
                                        id: 'rule_001',
                                        type: 'visibility',
                                        sourceComponent: 'comp_select_001',
                                        condition: 'equals',
                                        value: 'enterprise',
                                        targetComponent: 'comp_group_001',
                                        action: 'visible'
                                    },
                                    {
                                        id: 'rule_002',
                                        type: 'visibility',
                                        sourceComponent: 'comp_select_001',
                                        condition: 'notEquals',
                                        value: 'enterprise',
                                        targetComponent: 'comp_group_001',
                                        action: 'hidden'
                                    }
                                ]
                            },
                            theme: {
                                primaryColor: '#1890ff',
                                backgroundColor: '#ffffff',
                                borderColor: '#d9d9d9',
                                borderRadius: '6px',
                                fontSize: '14px',
                                textColor: '#000000'
                            }
                        },
                        runtime: {
                            componentValues: {
                                'comp_input_001': '',
                                'comp_select_001': 'normal',
                                'comp_textarea_001': ''
                            },
                            selectedServices: {},
                            orderItems: {}
                        }
                    },
                    status: 'draft'
                };

                // åˆ›å»ºè¡¨å•
                const createResponse = await fetch(`${API_BASE}/forms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(complexFormData)
                });
                
                const createResult = await createResponse.json();
                if (!createResult.success) {
                    addResult('designer', 'error', 'âŒ åˆ›å»ºå¤æ‚è¡¨å•å¤±è´¥', createResult);
                    return;
                }
                
                const formId = createResult.data._id;
                addResult('designer', 'success', 'âœ… å¤æ‚è¡¨å•åˆ›å»ºæˆåŠŸ');

                // éªŒè¯æ•°æ®å®Œæ•´æ€§
                const getResponse = await fetch(`${API_BASE}/forms/${formId}`);
                const getResult = await getResponse.json();
                
                if (getResult.success) {
                    const content = getResult.data.content;
                    const validation = {
                        hasMetadata: !!content.metadata,
                        hasComponents: content.config?.components?.length > 0,
                        hasLayout: !!content.config?.layout,
                        hasTheme: !!content.config?.theme,
                        hasLogicRules: content.config?.layout?.logicRules?.length > 0,
                        hasRuntime: !!content.runtime,
                        componentCount: content.config?.components?.length || 0,
                        logicRuleCount: content.config?.layout?.logicRules?.length || 0,
                        groupComponentExists: content.config?.components?.some(c => c.type === 'group'),
                        parentChildRelationship: content.config?.components?.some(c => c.parentId)
                    };
                    
                    addResult('designer', 'success', 'âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡', validation);
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    await fetch(`${API_BASE}/forms/${formId}`, { method: 'DELETE' });
                    addResult('designer', 'info', 'ğŸ§¹ æµ‹è¯•æ•°æ®å·²æ¸…ç†');
                    
                } else {
                    addResult('designer', 'error', 'âŒ æ•°æ®éªŒè¯å¤±è´¥', getResult);
                }

            } catch (error) {
                addResult('designer', 'error', `âŒ å¤æ‚æ•°æ®æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>
